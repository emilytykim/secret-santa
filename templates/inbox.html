<!-- inbox.html -->
{% extends "base.html" %}
{% block title %}Your Inbox{% endblock %}
{% block content %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“© Your Inbox</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“© Your Inbox</h1>

        {% if messages %}
            <p>Dear {{ name }},</p>
            <p>You have received <strong>{{ messages | length }}</strong> messages! ğŸ’Œ</p>

            <ul class="message-list">
                {% for message in messages %}
                    <li class="message-item">
                        <p>âœ‰ï¸ <strong>Anonymous:</strong> {{ message[1] }}</p>
                        {% if message[2] %}
                            <p>â†©ï¸ <strong>Your Reply:</strong> {{ message[2] }}</p>
                        {% else %}
                            <form 
                                action="{{ url_for('send_message',
                                group_id=group_id,
                                sender_id=session['user_id'],
                                receiver_id=message[4]) }}"
                                method="POST"
                            >
                        <textarea name="message" placeholder="Write your reply hereâ€¦" required></textarea>
                        <input type="hidden" name="reply_to" value="{{ message[0] }}">
                        <button type="submit">â†©ï¸ Send Reply</button>
                    </form>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>ğŸ“­ No new messages yet. Try again later!</p>
        {% endif %}

        <a href="{{ url_for('result', group_id=group_id, name=name) }}" class="btn">ğŸ”™ Back to Match</a>
    </div>

<script>
    // ëª¨ë“  â€œSend Replyâ€ í¼ì„ ì°¾ì•„ì„œ AJAX ë¡œ ì²˜ë¦¬
    document.querySelectorAll('.message-item form').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();  // ê¸°ë³¸ í¼ ì œì¶œ ì°¨ë‹¨
    
        fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(new FormData(form))
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // AJAX ì„±ê³µ ì‹œ, í˜ì´ì§€ë¥¼ ë¦¬ë¡œë“œ í•´ ìƒˆë¡œê³ ì¹¨ëœ inboxë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤
            window.location.reload();
          } else {
            alert(data.error);
          }
        })
        .catch(err => alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'));
      });
    });
    </script>
    
</body>
</html>

{% endblock %}